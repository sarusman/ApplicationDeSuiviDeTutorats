<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/menu}">
<head>
    <meta charset="UTF-8">
    <title>Détails de l'apprenti</title>
    <link rel="stylesheet" th:href="@{/css/traineeDetails.css}">
</head>
<body>
<section layout:fragment="content">

    <div class="container-fluid">

        <!-- Messages flash -->
        <div th:if="${updateSuccess}" class="alert alert-success text-center fw-bold" role="alert"
             style="max-width: 600px; margin: 20px auto;">
            <i class="bi bi-check2-circle"></i>
            <span th:text="${updateSuccess}">Mise à jour réussie.</span>
        </div>

        <div th:if="${updateError}" class="alert alert-danger text-center fw-bold" role="alert"
             style="max-width: 600px; margin: 20px auto;">
            <i class="bi bi-x-circle"></i>
            <span th:text="${updateError}">Erreur lors de la mise à jour.</span>
        </div>

        <!-- Infos générales -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="mb-0" th:text="'Informations générales de ' + ${apprentieDetailDTO.apprenti.prenom} + ' ' + ${apprentieDetailDTO.apprenti.nom}"></h2>

                <button type="button"
                        class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#updateTraineeModal">
                    <i class="bi bi-pencil-square"></i> Éditer
                </button>
            </div>
            <div class="card-body">
                <table class="table table-striped table-hover">
                    <tbody>
                    <tr>
                        <th style="width: 25%;">Prénom</th>
                        <td th:text="${apprentieDetailDTO.apprenti.prenom}">John</td>
                    </tr>
                    <tr>
                        <th>Nom</th>
                        <td th:text="${apprentieDetailDTO.apprenti.nom}"></td>
                    </tr>
                    <tr>
                        <th>Email</th>
                        <td th:text="${apprentieDetailDTO.apprenti.adresseElectronique != null ? apprentieDetailDTO.apprenti.adresseElectronique : 'NA'}"></td>
                    </tr>
                    <tr>
                        <th>Téléphone</th>
                        <td th:text="${apprentieDetailDTO.apprenti.telephone != null && apprentieDetailDTO.apprenti.telephone != '' ? apprentieDetailDTO.apprenti.telephone : 'NA'}"></td>
                    </tr>
                    <tr>
                        <th>Programme</th>
                        <td th:text="${apprentieDetailDTO.anneeAlternance.programme != null ? apprentieDetailDTO.anneeAlternance.programme : 'NA'}"></td>
                    </tr>
                    <tr>
                        <th>Année académique</th>
                        <td th:text="${apprentieDetailDTO.anneeAlternance.anneeAcademique != null && apprentieDetailDTO.anneeAlternance.anneeAcademique.name() != '' ? apprentieDetailDTO.anneeAlternance.anneeAcademique.name() : 'NA'}"></td>
                    </tr>
                    <tr>
                        <th>Entreprise</th>
                        <td th:text="${apprentieDetailDTO.anneeAlternance.entreprise != null ? apprentieDetailDTO.anneeAlternance.entreprise.raisonSociale : 'NA'}"></td>
                    </tr>
                    <tr>
                        <th>Tuteur d'entreprise</th>
                        <td th:text="${apprentieDetailDTO.anneeAlternance.tuteurEntreprise != null ? apprentieDetailDTO.anneeAlternance.tuteurEntreprise.prenom + ' ' + apprentieDetailDTO.anneeAlternance.tuteurEntreprise.nom : 'NA'}"></td>
                    </tr>
                    <tr>
                        <th>Dernière visite le</th>
                        <td th:text="${derniereVisite.isPresent() ? #temporals.format(derniereVisite.get().date, 'dd/MM/yyyy') : 'Aucune visite passée'}"></td>
                    </tr>
                    <tr>
                        <th>Prochaine visite le</th>
                        <td th:text="${prochaineVisite.isPresent() ? #temporals.format(prochaineVisite.get().date, 'dd/MM/yyyy') : 'Aucune visite à venir'}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Historique des visites -->
<!--        <div class="card">-->
<!--            <div class="card-header">-->
<!--                <h2>Historique des visites</h2>-->
<!--            </div>-->
<!--            <div class="card-body">-->
<!--                <table class="table table-striped table-hover">-->
<!--                    <thead>-->
<!--                    <tr>-->
<!--                        <th>Date de la visite</th>-->
<!--                        <th>Format</th>-->
<!--                        <th>Commentaires</th>-->
<!--                    </tr>-->
<!--                    </thead>-->
<!--                    <tbody>-->
<!--                    <tr th:each="visite : ${apprenti.visites}">-->
<!--                        <td th:text="${visite.date != null ? #temporals.format(visite.date, 'dd/MM/yyyy') : 'Date non définie'}"></td>-->
<!--                        <td th:text="${visite.format}"></td>-->
<!--                        <td th:text="${visite.commentaires}"></td>-->
<!--                    </tr>-->

<!--                    <tr th:if="${#lists.isEmpty(apprenti.visites)}">-->
<!--                        <td colspan="3" class="text-center">Aucune visite enregistrée pour cet apprenti.</td>-->
<!--                    </tr>-->
<!--                    </tbody>-->
<!--                </table>-->
<!--            </div>-->
<!--        </div>-->

    </div>


    <!-- Modale de mise à jour de l'apprenti -->
    <div class="modal fade" id="updateTraineeModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <form th:action="@{/apprenti/update/{id}(id=${apprentieDetailDTO.apprenti.id})}"
                      th:object="${apprentieDetailDTO}"
                      method="post">

                    <div class="modal-header">
                        <h5 class="modal-title" id="updateModalLabel">
                            Mise à jour du profil de
                            <span th:text="${apprentieDetailDTO.apprenti.prenom}">Prénom</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                    </div>

                    <div class="modal-body">
                        <div class="container-fluid">

                            <input type="hidden" th:field="*{apprenti.id}"/>

                            <!-- Ligne 1 : Nom / Prénom -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="prenom" class="form-label">Prénom *</label>
                                    <input type="text" id="prenom" class="form-control" th:field="*{apprenti.prenom}" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="nom" class="form-label">Nom *</label>
                                    <input type="text" id="nom" class="form-control" th:field="*{apprenti.nom}" required>
                                </div>
                            </div>

                            <!-- Ligne 2 : Email / Téléphone -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="adresseElectronique" class="form-label">Adresse Électronique *</label>
                                    <input type="email"
                                           id="adresseElectronique"
                                           class="form-control"
                                           th:field="*{apprenti.adresseElectronique}"
                                           required>
                                </div>
                                <div class="col-md-6">
                                    <label for="telephone" class="form-label">Téléphone</label>
                                    <input type="tel"
                                           id="telephone"
                                           class="form-control"
                                           th:field="*{apprenti.telephone}"
                                           pattern="[0-9]{10}"
                                           placeholder="0123456789">
                                </div>
                            </div>

                            <!-- Ligne 3 : Programme / Année académique -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="programme" class="form-label">Programme *</label>
                                    <select id="programme"
                                            class="form-select"
                                            th:field="*{anneeAlternance.programme}"
                                            required>
                                        <option value="">Choisir un programme...</option>
                                        <option th:each="prog : ${programmes}"
                                                th:value="${prog}"
                                                th:text="${prog}">
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="anneeAcademique" class="form-label">Année Académique</label>
                                    <input type="text"
                                           id="anneeAcademique"
                                           class="form-control"
                                           th:field="*{anneeAlternance.anneeAcademique}"
                                           placeholder="ex: 2024-2025">
                                </div>
                            </div>

                            <!-- Ligne 4 : Entreprise / Tuteur d'entreprise -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="entrepriseSelectModal" class="form-label">Entreprise *</label>
                                    <select id="entrepriseSelectModal"
                                            class="form-select"
                                            th:field="*{anneeAlternance.entreprise}"
                                            required>
                                        <option value="">Choisir une entreprise...</option>
                                        <option th:each="ent : ${entreprises}"
                                                th:value="${ent.id}"
                                                th:text="${ent.raisonSociale}">
                                        </option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label for="tuteurSelectModal" class="form-label">Tuteur d'entreprise *</label>
                                    <select id="tuteurSelectModal"
                                            class="form-select"
                                            th:field="*{anneeAlternance.tuteurEntreprise}"
                                            required>
                                        <!-- si l'apprenti a déjà un tuteurEntreprise on le met 1er choix -->
                                        <option th:if="*{anneeAlternance.tuteurEntreprise != null}"
                                                th:value="*{anneeAlternance.tuteurEntreprise.id}"
                                                th:text="*{anneeAlternance.tuteurEntreprise.prenom + ' ' + anneeAlternance.tuteurEntreprise.nom}">
                                        </option>

                                        <!-- sinon placeholder -->
                                        <option th:if="*{anneeAlternance.tuteurEntreprise == null}"
                                                value="">
                                            -- Sélectionner un tuteur --
                                        </option>
                                    </select>
                                    <!-- note: comme sur le dashboard, le JS côté front peut recharger les tuteurs
                                         selon l'entreprise choisie -->
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button"
                                class="btn btn-outline-secondary"
                                data-bs-dismiss="modal">Annuler</button>

                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-floppy"></i>
                            Sauvegarder
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script th:src="@{/js/traineeDetails.js}"></script>
    </th:block>

</section>
</body>
</html>
